from type.colors import Colors
from apps.apphabit import apphabit

from integration.loghandler import Loghandler

import math

class pong(apphabit):

	def __init__(self, id, node, controller, height, width, params):
		#base
		self.id = id
		self.node = node
		self.controller = controller
		self.height = height
		self.width = width

		self.mouselen = controller.mouselen
		Loghandler.Log(f"pong init, {self.mouselen} mouses detected")

		#self.node.resize(15, 65)

		self.ball_y = 7
		self.ball_x = 32

		self.ball_ry = 7.0
		self.ball_rx = 32.0


		self.ball_dir = 75.0
		self.ball_speed = 0.4

		self.player1_y = 0
		self.player2_y = 0
		self.player1_speed = 0
		self.player2_speed = 0
		self.p1score = 0
		self.p2score = 0

		self.platform_width = 5


	def draw(self):
		write = self.node.appendStr
		w = self.platform_width
		p1 = self.player1_y
		p2 = self.player2_y
		for y in range(16):
			if y >= p1 and y < p1 + w:
				write(y, 0, '|')
			if y >= p2 and y < p2 + w:
				write(y, 64, '|')
			write(self.ball_y, self.ball_x, ' ', Colors.colorPair(1) | Colors.FXReverse)

		#process the ball
		self.ball_rx += math.cos(self.ball_dir) * self.ball_speed
		self.ball_ry += math.sin(self.ball_dir) * self.ball_speed

		if self.ball_rx <= 0.5 and self.ball_ry >= p1 and self.ball_ry < p1 + w:
			self.ball_dir += math.atan2(1, p1 - self.ball_ry - self.controller[0].mouse_dy)
			self.ball_dir = (-self.ball_dir + 180.0) % 360.0 - 180.0
			self.ball_rx = 1.0

		elif self.ball_rx >= 63.5 and self.ball_ry >= p2 and self.ball_ry < p2 + w:
			self.ball_dir += math.atan2(1, p2 - self.ball_y - self.controller[0].mouse_dy)
			self.ball_dir = (-self.ball_dir + 180.0) % 360.0 - 180.0
			self.ball_rx = 63.0


		self.ball_dir = (self.ball_dir + 180.0) % 360.0 - 180.0

		if self.ball_ry <= 0.5:
			self.ball_dir = (-self.ball_dir + 180.0) % 360.0 - 180.0
			self.ball_ry = 1

		elif self.ball_ry >= 14.5:
			self.ball_dir = (-self.ball_dir + 180.0) % 360.0 - 180.0
			self.ball_ry = 14

		self.ball_dir = (self.ball_dir + 180.0) % 360.0 - 180.0

		if self.ball_rx < -0.5 or self.ball_rx > 64.5:
			if self.ball_rx > 0.0:
				self.p2score += 1
			else:
				self.p1score += 1
			self.ball_dir = -75.0 if self.ball_rx > 0.0 else 75.0
			self.ball_ry = 7.0
			self.ball_rx = 32.0

		self.ball_y = round(self.ball_ry)
		self.ball_x = round(self.ball_rx)

		p1 = min(max(self.controller[0].mouse_y - self.node.from_y, 0), self.height) - (w >> 1)
		if self.mouselen > 1:
			p2 = min(max(self.controller[1].mouse_y - self.node.from_y, 0), self.height) - (w >> 1)
		else:
			p2 = self.player1_y
		#Loghandler.Log(f"{self.controller[0].mouse_y} {self.controller[1].mouse_y}")
		write(3, 31, f"{self.p1score}:{self.p2score}")


		self.player1_speed += (p1 - self.player1_y - self.player1_speed) / 20
		self.player2_speed += (p2 - self.player2_y - self.player2_speed) / 20
		self.player1_y = p1
		self.player2_y = p2

	def onresize(self, height, width):
		self.node.resize(15, 65)
